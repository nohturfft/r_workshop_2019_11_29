---
title: "Filtering exome sequence data using an R (markdown) script"
author: "Axel Nohturfft"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    code_folding: "hide"
    number_sections: FALSE
    theme: "sandstone"
    highlight: "tango"
    fig_caption: TRUE
---

<style>
h1 {background: brown;color: white;padding-left: 7px;}
h2 {background: grey;color: white;padding-left: 7px;}
h3 {color: brown;}
</style>

# Intro  
## Aims  
With this script we'll cover:  

1. Using rmarkdown and generating an html report  
2. Filtering a large data sets (R data frame)  
3. Using the very popular `dplyr` package  

## R markdown  
Like regular R scripts, rmarkdown scripts are just text files (with the .Rmd extension), differ from regular R scripts in three principal ways:  

1. In normal R scripts (.R files) text is interpreted by default _**as code**_, whilecomments have to be preceded by a '#'. Conversely, in rmarkdown scripts (.Rmd files) text is interpreted by default as _**formatted comments**_; code has to be enclosed in so-called 'chunks' that are are framed by three back-ticks (see code). RStudio highlights these code chunks with a grey background.  
2. In rmarkdown scripts the output from the code chunks is shown within the script itself.  
3. Rmarkdown is extremely useful in generating very professional reports in any of various common formats (e.g. html, Word, PDF, Powerpoint)  


More information about rmarkdown can be found [here](https://rmarkdown.rstudio.com/).  

# Setup  
## Parameters + packages  
```{r}
lib.loc <- "/homedirs8/workshops/190301-R/packages_3_5_0"
stopifnot(file.exists(lib.loc))
.libPaths(lib.loc)
```

```{r results="hide"}
library(magrittr, lib.loc=lib.loc)
library(dplyr, lib.loc=lib.loc)
library(stringi, lib.loc=lib.loc)
library(rmarkdown, lib.loc=lib.loc)
library(DT, lib.loc=lib.loc)
```


## Input data  
```{r define data file, results="asis"}
# This code assumes that the data file is in the working directory.
# Use setwd() to change the working directory or use the complete path to the data file below.
data.file <- "data/M003_annovar_hg19_multianno_crop.txt"
# Stop the script if the data file cannot be found in the current working directory:
stopifnot(file.exists(data.file))
cat("Data file: <tt><b>", data.file, "</b></tt>\n")
```

## Read data  
```{r read data}
# only 141 headers, but
m003 <- read.table(file=data.file, sep="\t", header=T, stringsAsFactors = FALSE)
# m003 <- read.table(file=data.file, sep="\t", header=F, nrows=1)
```

# Inspect the imported data  
## Object class generated by read.table()  
```{r}
class(m003)
```

## Number of rows and columns  
```{r}
dim(m003)
```

**Generating nicer output:**  
```{r results="asis"}
cat("Number of data columns:", ncol(m003))
```

```{r results="asis"}
cat("Number of data rows:", nrow(m003))
```


## Column headers:  
```{r results="asis"}
data.frame(Column.No=seq_len(ncol(m003)), Column.Name=names(m003)) %>%
  knitr::kable(., align=rep("c", ncol(m003)))
```

```{r message=FALSE, warning=FALSE}
m003$gnomAD_exome_ALL[!is.na(m003$gnomAD_exome_ALL)] %>% 
  as.numeric(na.rm=T) %>%
  hist(., main="Histogram of variant frequencies", xlab="Frequency")
```


Keep only rare variants (frequency of less than 0.0001)  
```{r}
m003 %>% 
  filter(gnomAD_exome_ALL < 0.0001) %>% 
  nrow
# 33445
```

Should include variants that have never been seen before (i.e. not in database, represented as NA in the data frame):
```{r}
m003 %>% 
  filter(gnomAD_exome_ALL < 0.0001 | is.na(gnomAD_exome_ALL)) %>% 
  nrow # 33953
```

Get rid of silent mutations (synonymous):
```{r}
m003 %>% 
  filter(gnomAD_exome_ALL < 0.0001 | is.na(gnomAD_exome_ALL)) %>% 
  filter(! ExonicFunc.refGene %in% c(NA, "synonymous SNV", "unknown")) %>% 
  nrow # 523
```

The Gene.refGene column contains the gene symbols - save in a variable:
```{r}
interesting.variants <- m003 %>% 
  filter(gnomAD_exome_ALL < 0.01 | is.na(gnomAD_exome_ALL)) %>% 
  filter(! ExonicFunc.refGene %in% c(NA, "synonymous SNV", "unknown", "nonframeshift insertion", "nonframeshift deletion" )) %>% 
  .$Gene.refGene %>% 
  as.character
# 361
```

How many are there?
```{r}
length(interesting.variants)
```

Any duplicates?
```{r}
any(duplicated(interesting.variants))
```

Remove duplicates:
```{r}
interesting.variants <- unique(interesting.variants)
length(interesting.variants) # 493
```

Sort alphabetically:
```{r}
interesting.variants <- sort(interesting.variants)
```

Print:
```{r}
cat(interesting.variants, sep=", ")
```

Save in a file:
```{r}
out.file <- "interesting_variants.txt"
cat(interesting.variants, sep="\n", file=out.file)
```


# Session info  
To properly document your data analysis always include the session info, which includes e.g. the versions of R and of any packages used:  
```{r}
sessionInfo()
```

